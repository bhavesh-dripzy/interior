name: Deploy to Production VM

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Build frontend
      env:
        VITE_API_BASE_URL: https://houzzat.in/api
      run: |
        cd interior
        npm install
        npm run build
        ls -la dist/ || { echo "‚ùå Frontend build failed - dist folder not found"; exit 1; }
        echo "‚úÖ Frontend built successfully"
    
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Check if secrets are set
        if [ -z "${{ secrets.VM_SSH_PRIVATE_KEY }}" ]; then
          echo "‚ùå VM_SSH_PRIVATE_KEY secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.VM_USER }}" ]; then
          echo "‚ùå VM_USER secret is not set!"
          exit 1
        fi
        
        # Write SSH key and fix formatting (handle single-line paste from GitHub Secrets)
        echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key_temp
        
        # Verify key file was written and has content
        if [ ! -s ~/.ssh/deploy_key_temp ]; then
          echo "‚ùå SSH key file is empty or was not written!"
          exit 1
        fi
        echo "‚úÖ SSH key file written (size: $(wc -c < ~/.ssh/deploy_key_temp) bytes)"
        
        # Create Python script to format the key (handle malformed markers)
        printf 'import sys, re, os\n' > /tmp/format_key.py
        printf 'key = open(os.path.expanduser("~/.ssh/deploy_key_temp")).read()\n' >> /tmp/format_key.py
        printf '# Find BEGIN and END markers\n' >> /tmp/format_key.py
        printf 'begin_idx = key.find("-----BEGIN")\n' >> /tmp/format_key.py
        printf 'end_idx = key.find("-----END")\n' >> /tmp/format_key.py
        printf 'if begin_idx < 0 or end_idx < 0 or end_idx <= begin_idx:\n' >> /tmp/format_key.py
        printf '    print("‚ùå Could not find BEGIN or END markers", file=sys.stderr)\n' >> /tmp/format_key.py
        printf '    sys.exit(1)\n' >> /tmp/format_key.py
        printf '# Determine key type and reconstruct proper BEGIN line\n' >> /tmp/format_key.py
        printf 'begin_section = key[begin_idx:min(begin_idx+100, end_idx)]\n' >> /tmp/format_key.py
        printf 'if "OPENSSH" in begin_section:\n' >> /tmp/format_key.py
        printf '    begin_line = "-----BEGIN OPENSSH PRIVATE KEY-----"\n' >> /tmp/format_key.py
        printf '    # Find where base64 starts (after KEY, skip dashes/spaces)\n' >> /tmp/format_key.py
        printf '    key_marker = begin_section.find("KEY")\n' >> /tmp/format_key.py
        printf '    if key_marker >= 0:\n' >> /tmp/format_key.py
        printf '        base64_start = begin_idx + key_marker + 3\n' >> /tmp/format_key.py
        printf '        # Skip dashes, spaces, newlines\n' >> /tmp/format_key.py
        printf '        while base64_start < len(key) and key[base64_start] in ["-", " ", "\\n", "\\r"]:\n' >> /tmp/format_key.py
        printf '            base64_start += 1\n' >> /tmp/format_key.py
        printf '    else:\n' >> /tmp/format_key.py
        printf '        base64_start = begin_idx + len("-----BEGIN OPENSSH PRIVATE KEY-----")\n' >> /tmp/format_key.py
        printf 'elif "RSA" in begin_section:\n' >> /tmp/format_key.py
        printf '    begin_line = "-----BEGIN RSA PRIVATE KEY-----"\n' >> /tmp/format_key.py
        printf '    key_marker = begin_section.find("KEY")\n' >> /tmp/format_key.py
        printf '    if key_marker >= 0:\n' >> /tmp/format_key.py
        printf '        base64_start = begin_idx + key_marker + 3\n' >> /tmp/format_key.py
        printf '        while base64_start < len(key) and key[base64_start] in ["-", " ", "\\n", "\\r"]:\n' >> /tmp/format_key.py
        printf '            base64_start += 1\n' >> /tmp/format_key.py
        printf '    else:\n' >> /tmp/format_key.py
        printf '        base64_start = begin_idx + len("-----BEGIN RSA PRIVATE KEY-----")\n' >> /tmp/format_key.py
        printf 'else:\n' >> /tmp/format_key.py
        printf '    begin_line = "-----BEGIN PRIVATE KEY-----"\n' >> /tmp/format_key.py
        printf '    key_marker = begin_section.find("KEY")\n' >> /tmp/format_key.py
        printf '    if key_marker >= 0:\n' >> /tmp/format_key.py
        printf '        base64_start = begin_idx + key_marker + 3\n' >> /tmp/format_key.py
        printf '        while base64_start < len(key) and key[base64_start] in ["-", " ", "\\n", "\\r"]:\n' >> /tmp/format_key.py
        printf '            base64_start += 1\n' >> /tmp/format_key.py
        printf '    else:\n' >> /tmp/format_key.py
        printf '        base64_start = begin_idx + len("-----BEGIN PRIVATE KEY-----")\n' >> /tmp/format_key.py
        printf '# Determine END line\n' >> /tmp/format_key.py
        printf 'end_section = key[end_idx:min(end_idx+100, len(key))]\n' >> /tmp/format_key.py
        printf 'if "OPENSSH" in end_section:\n' >> /tmp/format_key.py
        printf '    end_line = "-----END OPENSSH PRIVATE KEY-----"\n' >> /tmp/format_key.py
        printf 'elif "RSA" in end_section:\n' >> /tmp/format_key.py
        printf '    end_line = "-----END RSA PRIVATE KEY-----"\n' >> /tmp/format_key.py
        printf 'else:\n' >> /tmp/format_key.py
        printf '    end_line = "-----END PRIVATE KEY-----"\n' >> /tmp/format_key.py
        printf '# Extract and clean base64 content (remove all non-base64 chars)\n' >> /tmp/format_key.py
        printf 'base64_content = key[base64_start:end_idx].replace("\\n", "").replace("\\r", "").replace(" ", "").replace("-", "").strip()\n' >> /tmp/format_key.py
        printf '# Reconstruct key with proper formatting\n' >> /tmp/format_key.py
        printf 'formatted_key = begin_line + "\\n"\n' >> /tmp/format_key.py
        printf 'for i in range(0, len(base64_content), 64):\n' >> /tmp/format_key.py
        printf '    formatted_key += base64_content[i:i+64] + "\\n"\n' >> /tmp/format_key.py
        printf 'formatted_key += end_line + "\\n"\n' >> /tmp/format_key.py
        printf 'open(os.path.expanduser("~/.ssh/deploy_key"), "w").write(formatted_key)\n' >> /tmp/format_key.py
        printf 'print("‚úÖ SSH key formatted and written")\n' >> /tmp/format_key.py
        
        python3 /tmp/format_key.py
        
        chmod 600 ~/.ssh/deploy_key
        
        # Verify key format
        if ! ssh-keygen -l -f ~/.ssh/deploy_key > /dev/null 2>&1; then
          echo "‚ùå Invalid SSH key format!"
          echo "Key file contents (first 10 lines):"
          head -10 ~/.ssh/deploy_key
          exit 1
        fi
        echo "‚úÖ SSH key format verified"
        ssh-keyscan -H 34.73.5.92 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Test SSH connection
        echo "üîç Testing SSH connection to ${{ secrets.VM_USER }}@34.73.5.92..."
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
          ${{ secrets.VM_USER }}@34.73.5.92 'echo "SSH connection successful"' || {
          echo "‚ùå SSH connection failed!"
          echo "Please verify:"
          echo "  1. VM_SSH_PRIVATE_KEY secret is set correctly"
          echo "  2. VM_USER secret is set to: nishkarsh"
          echo "  3. SSH public key is added to VM's ~/.ssh/authorized_keys"
          exit 1
        }
        echo "‚úÖ SSH connection successful"
    
    - name: Deploy Backend
      run: |
        cd interior/backend
        # Create archive - ignore file changed warnings (non-fatal)
        tar -czf backend-deploy.tar.gz \
          --warning=no-file-changed \
          --exclude='venv' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.git' \
          --exclude='db.sqlite3' \
          --exclude='media' \
          --exclude='staticfiles' \
          --exclude='*.log' \
          --exclude='.DS_Store' \
          --exclude='*.swp' \
          --exclude='*.tmp' \
          . || { echo "‚ö†Ô∏è tar completed with warnings (this is usually OK)"; }
        
        # Verify archive was created
        if [ ! -f backend-deploy.tar.gz ]; then
          echo "‚ùå Archive was not created!"
          exit 1
        fi
        echo "‚úÖ Backend archive created: $(ls -lh backend-deploy.tar.gz | awk '{print $5}')"
        
        echo "üì§ Uploading backend files..."
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          backend-deploy.tar.gz ${{ secrets.VM_USER }}@34.73.5.92:~/backend-deploy.tar.gz || exit 1
        
        echo "üîß Deploying backend on VM..."
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@34.73.5.92 bash -c "
          set -e
          cd ~
          tar -xzf backend-deploy.tar.gz
          sudo cp -r * /var/www/interior-app/backend/
          cd /var/www/interior-app/backend
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          sudo chown -R www-data:www-data /var/www/interior-app/backend
          sudo systemctl restart gunicorn
          echo '‚úÖ Backend deployed'
        " || exit 1
    
    - name: Deploy Frontend
      run: |
        cd interior
        if [ ! -d "dist" ]; then
          echo "‚ùå dist folder not found. Build may have failed."
          exit 1
        fi
        tar -czf frontend-dist.tar.gz -C dist .
        echo "üì¶ Frontend archive created: $(ls -lh frontend-dist.tar.gz)"
        
        echo "üì§ Uploading frontend files..."
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          frontend-dist.tar.gz ${{ secrets.VM_USER }}@34.73.5.92:~/frontend-dist.tar.gz || exit 1
        
        echo "üîß Deploying frontend on VM..."
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@34.73.5.92 bash -c "
          set -e
          cd ~
          tar -xzf frontend-dist.tar.gz
          sudo rm -rf /var/www/interior-app/frontend/*
          sudo cp -r * /var/www/interior-app/frontend/
          sudo chown -R www-data:www-data /var/www/interior-app/frontend
          sudo systemctl restart nginx
          echo '‚úÖ Frontend deployed'
        " || exit 1
    
    - name: Verify Deployment
      run: |
        sleep 5
        curl -f http://34.73.5.92/api/health/ || exit 1
        echo "‚úÖ Deployment verified"

