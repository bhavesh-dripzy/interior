name: Deploy to Production VM

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Build frontend
      env:
        VITE_API_BASE_URL: http://34.73.5.92/api
      run: |
        cd interior
        npm install
        npm run build
        ls -la dist/ || { echo "‚ùå Frontend build failed - dist folder not found"; exit 1; }
        echo "‚úÖ Frontend built successfully"
    
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Check if secrets are set
        if [ -z "${{ secrets.VM_SSH_PRIVATE_KEY }}" ]; then
          echo "‚ùå VM_SSH_PRIVATE_KEY secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.VM_USER }}" ]; then
          echo "‚ùå VM_USER secret is not set!"
          exit 1
        fi
        
        echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H 34.73.5.92 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Test SSH connection
        echo "üîç Testing SSH connection to ${{ secrets.VM_USER }}@34.73.5.92..."
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
          ${{ secrets.VM_USER }}@34.73.5.92 'echo "SSH connection successful"' || {
          echo "‚ùå SSH connection failed!"
          echo "Please verify:"
          echo "  1. VM_SSH_PRIVATE_KEY secret is set correctly"
          echo "  2. VM_USER secret is set to: nishkarsh"
          echo "  3. SSH public key is added to VM's ~/.ssh/authorized_keys"
          exit 1
        }
        echo "‚úÖ SSH connection successful"
    
    - name: Deploy Backend
      run: |
        cd interior/backend
        tar -czf backend-deploy.tar.gz \
          --exclude='venv' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.git' \
          --exclude='db.sqlite3' \
          --exclude='media' \
          --exclude='staticfiles' \
          .
        
        echo "üì§ Uploading backend files..."
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          backend-deploy.tar.gz ${{ secrets.VM_USER }}@34.73.5.92:~/backend-deploy.tar.gz || exit 1
        
        echo "üîß Deploying backend on VM..."
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@34.73.5.92 bash -c "
          set -e
          cd ~
          tar -xzf backend-deploy.tar.gz
          sudo cp -r * /var/www/interior-app/backend/
          cd /var/www/interior-app/backend
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          sudo chown -R www-data:www-data /var/www/interior-app/backend
          sudo systemctl restart gunicorn
          echo '‚úÖ Backend deployed'
        " || exit 1
    
    - name: Deploy Frontend
      run: |
        cd interior
        if [ ! -d "dist" ]; then
          echo "‚ùå dist folder not found. Build may have failed."
          exit 1
        fi
        tar -czf frontend-dist.tar.gz -C dist .
        echo "üì¶ Frontend archive created: $(ls -lh frontend-dist.tar.gz)"
        
        echo "üì§ Uploading frontend files..."
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          frontend-dist.tar.gz ${{ secrets.VM_USER }}@34.73.5.92:~/frontend-dist.tar.gz || exit 1
        
        echo "üîß Deploying frontend on VM..."
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@34.73.5.92 bash -c "
          set -e
          cd ~
          tar -xzf frontend-dist.tar.gz
          sudo rm -rf /var/www/interior-app/frontend/*
          sudo cp -r * /var/www/interior-app/frontend/
          sudo chown -R www-data:www-data /var/www/interior-app/frontend
          sudo systemctl restart nginx
          echo '‚úÖ Frontend deployed'
        " || exit 1
    
    - name: Verify Deployment
      run: |
        sleep 5
        curl -f http://34.73.5.92/api/health/ || exit 1
        echo "‚úÖ Deployment verified"

